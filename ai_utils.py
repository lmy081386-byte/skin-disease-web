def _fmt_top3(top3):
    if not top3:
        return "لا يوجد"
    lines = []
    for x in top3[:3]:
        try:
            lbl = x.get("label", "غير معروف")
            conf = x.get("confidence", 0.0)
            lines.append(f"- {lbl}: {round(float(conf) * 100, 2)}%")
        except Exception:
            lines.append("- (تنسيق نتائج غير معروف)")
    return "\n".join(lines)


def _normalize_label(label: str) -> str:
    return (label or "").strip().lower().replace("_", " ")


def disease_info_ar(label: str, top3: list, notes: str = "") -> str:
    label_clean = _normalize_label(label)
    top3_txt = _fmt_top3(top3)
    notes_txt = (notes or "").strip() or "لا يوجد"

    # قاعدة بيانات للأمراض الـ 20 (نص تثقيفي + OTC آمن + متى طبيب)
    DB = {
        "acne": {
            "name": "حبّ الشباب",
            "what": "انسداد مسام + التهاب يسبب رؤوس سوداء/بيضاء أو حبوب ملتهبة.",
            "safe": [
                "غسول لطيف مرتين يومياً بدون فرك قوي.",
                "تجنّبي عصر الحبوب لتفادي الندبات.",
                "استخدمي منتجات مكتوب عليها non-comedogenic."
            ],
            "otc": [
                "بنزويل بيروكسيد (قد يسبب جفاف—ابدئي تدريجي).",
                "حمض الساليسيليك للرؤوس السوداء.",
                "أدابالين إذا كان متاح بدون وصفة (تجنبيه بالحمل)."
            ],
            "see_doc": [
                "حب شباب شديد/ندبات/ألم قوي.",
                "عدم تحسن خلال 8–12 أسبوع."
            ]
        },

        "eczema": {
            "name": "الإكزيما",
            "what": "التهاب جلدي يسبب جفاف/حكة/احمرار ويزيد مع المهيجات.",
            "safe": [
                "ترطيب كثيف يومياً (خالي من العطر).",
                "تجنّبي الماء الحار والصابون المعطر.",
                "كمادات باردة للحكة."
            ],
            "otc": [
                "مرطّبات كثيفة (أساس العلاج).",
                "هيدروكورتيزون 1% لفترة قصيرة على بقع خفيفة إذا ما في جروح/عدوى (اسألي الصيدلي)."
            ],
            "see_doc": [
                "صديد/سخونة/ألم (اشتباه عدوى).",
                "إذا على الوجه/حول العين أو عند طفل صغير.",
                "عدم تحسن خلال 7–10 أيام."
            ]
        },

        "psoriasis": {
            "name": "الصدفية",
            "what": "مرض مناعي يسبب بقع سميكة متقشرة غالباً بالمرفقين/الركبتين/فروة الرأس.",
            "safe": [
                "ترطيب يومي وتقليل الحكّ.",
                "تجنّب المهيجات والتوتر قدر الإمكان."
            ],
            "otc": [
                "مرطبات كثيفة.",
                "شامبو قطران الفحم أو حمض الساليسيليك لفروة الرأس حسب العبوة."
            ],
            "see_doc": [
                "ألم/تورم مفاصل.",
                "انتشار واسع أو تشققات مؤلمة.",
                "عدم تحسن خلال 2–3 أسابيع."
            ]
        },

        "athlete foot": {
            "name": "فطريات القدم (Athlete’s foot)",
            "what": "عدوى فطرية تسبب حكة/تقشر/تشققات خصوصاً بين الأصابع.",
            "safe": [
                "جففي القدم جيداً خصوصاً بين الأصابع.",
                "غيّري الجوارب يومياً واهوي الحذاء."
            ],
            "otc": [
                "كريم/بخاخ مضاد فطري مثل كلوتريمازول أو تيربينافين حسب العبوة.",
                "بودرة مضادة للفطريات للمساعدة على الجفاف."
            ],
            "see_doc": [
                "سكري/ضعف مناعة.",
                "عدم تحسن خلال 1–2 أسبوع."
            ]
        },

        "nail fungus": {
            "name": "فطريات الأظافر",
            "what": "تغير لون/سماكة/تفتت الظفر وقد يحتاج علاج طويل.",
            "safe": [
                "حافظي على جفاف القدم.",
                "تجنّبي الأحذية الضيقة."
            ],
            "otc": [
                "مستحضرات موضعية للأظافر قد تساعد بالحالات الخفيفة لكنها بطيئة."
            ],
            "see_doc": [
                "ألم/التهاب حول الظفر.",
                "سكري/ضعف مناعة.",
                "انتشار في عدة أظافر."
            ]
        },

        "tinea": {
            "name": "تينيا/سعفة (Ringworm)",
            "what": "عدوى فطرية على الجلد قد تظهر كبقعة دائرية مع حكة وتقشر.",
            "safe": [
                "تجنبي مشاركة المناشف.",
                "حافظي على جفاف المنطقة."
            ],
            "otc": [
                "مضاد فطري موضعي مثل كلوتريمازول/تيربينافين حسب العبوة."
            ],
            "see_doc": [
                "إذا كانت على فروة الرأس أو تنتشر بسرعة.",
                "عدم تحسن خلال 1–2 أسبوع."
            ]
        },

        "urticaria": {
            "name": "الشرى/الأرتيكاريا (Hives)",
            "what": "طفح مرتفع حاك قد يظهر ويختفي، أحياناً بسبب حساسية.",
            "safe": [
                "تجنبي المسبب إن كان معروفاً.",
                "كمادات باردة للحكة."
            ],
            "otc": [
                "مضاد هيستامين غير مُنوِّم (اسألي الصيدلي حسب العمر/الحمل)."
            ],
            "see_doc": [
                "تورم شفاه/لسان أو صعوبة تنفس (طوارئ).",
                "استمرار متكرر أو شديد."
            ]
        },

        "rosacea": {
            "name": "الوردية (Rosacea)",
            "what": "احمرار مزمن بالوجه وقد يزيد مع الشمس/الحرارة/الأطعمة الحارة.",
            "safe": [
                "واقي شمس لطيف يومياً.",
                "تجنبي المحفزات (حرارة/أكل حار/عطور)."
            ],
            "otc": [
                "مرطبات لطيفة وواقي شمس للبشرة الحساسة."
            ],
            "see_doc": [
                "حرقان شديد/تفاقم سريع.",
                "إذا أثرت على العين."
            ]
        },

        "vitiligo": {
            "name": "البهاق (Vitiligo)",
            "what": "فقدان صبغة الجلد يسبب بقع بيضاء بدون قشور عادةً.",
            "safe": [
                "واقي شمس لمنع الحروق في المناطق الفاتحة.",
                "دعم نفسي لأن الحالة قد تؤثر على الثقة."
            ],
            "otc": [
                "واقي شمس + مرطب."
            ],
            "see_doc": [
                "للتشخيص المؤكد وخيارات العلاج."
            ]
        },

        "chickenpox": {
            "name": "جدري الماء (Chickenpox)",
            "what": "طفح حاك مع فقاعات صغيرة، قد يصاحبه حرارة.",
            "safe": [
                "تجنبي حكّ البثور لتفادي العدوى/الندبات.",
                "حافظي على النظافة وقصّي الأظافر."
            ],
            "otc": [
                "مستحضر كالامين للحكة.",
                "مسكن مناسب للحرارة (اسألي الصيدلي)."
            ],
            "see_doc": [
                "حمل/رضّع/ضعف مناعة.",
                "صعوبة تنفس أو طفح شديد جداً."
            ]
        },

        "shingles herpeszoster": {
            "name": "الحزام الناري (Shingles/Herpes Zoster)",
            "what": "طفح مؤلم على شكل شريط غالباً بجهة واحدة من الجسم.",
            "safe": [
                "تغطية الطفح وتجنب مخالطة الحوامل/ضعف المناعة حتى يجف.",
                "عدم فرقعة الفقاعات."
            ],
            "otc": [
                "مسكن للألم حسب الحالة (اسألي الصيدلي)."
            ],
            "see_doc": [
                "يفضل خلال 24–72 ساعة لبدء علاج فعال.",
                "إذا قرب العين/الوجه (طارئ)."
            ]
        },

        "impetigo": {
            "name": "القوباء (Impetigo)",
            "what": "عدوى جلدية سطحية (قشور عسلية) غالباً تحتاج تقييم وقد تحتاج علاج بوصفة.",
            "safe": [
                "نظافة لطيفة وعدم مشاركة المناشف.",
                "تغطية المنطقة لتقليل العدوى."
            ],
            "otc": [
                "لا يوجد OTC يعالجها عادةً بشكل كافي."
            ],
            "see_doc": [
                "يفضل زيارة طبيب/عيادة لأن غالباً تحتاج مضاد بوصفة."
            ]
        },

        "cellulitis": {
            "name": "التهاب النسيج الخلوي (Cellulitis) — حالة مهمة",
            "what": "عدوى بكتيرية تسبب احمرار/سخونة/ألم وقد تنتشر بسرعة.",
            "safe": [
                "ارفعي الطرف المصاب لتخفيف التورم.",
                "راقبي الانتشار (حددي الحواف بقلم)."
            ],
            "otc": [
                "مسكن بسيط للألم/الحرارة حسب المناسبة (اسألي الصيدلي)."
            ],
            "see_doc": [
                "اليوم/فوراً إذا في سخونة/ألم/انتشار سريع.",
                "حمّى، خطوط حمراء، تورم شديد، سكري/ضعف مناعة."
            ]
        },

        "sunburn": {
            "name": "حروق الشمس",
            "what": "التهاب بسبب الشمس يسبب احمرار/ألم وقد فقاعات.",
            "safe": [
                "كمادات باردة + ترطيب لطيف.",
                "شرب ماء وتجنب الشمس."
            ],
            "otc": [
                "جل ألوفيرا/مرطب لطيف.",
                "مسكن ألم مناسب حسب الحالة (اسألي الصيدلي)."
            ],
            "see_doc": [
                "فقاعات واسعة أو دوخة/حرارة أو طفل صغير."
            ]
        },

        "skin bruises": {
            "name": "كدمات جلدية (Bruises)",
            "what": "تجمع دم تحت الجلد غالباً بعد ضربة/ضغط.",
            "safe": [
                "كمادات باردة أول 24 ساعة.",
                "رفع المنطقة إن أمكن."
            ],
            "otc": [
                "مسكن مناسب للألم إذا لزم (اسألي الصيدلي)."
            ],
            "see_doc": [
                "كدمات متكررة بدون سبب واضح.",
                "ألم شديد/تورم كبير أو مع دوخة."
            ]
        },

        "melanocytic nevus": {
            "name": "شامة/وحمة صبغية (Melanocytic nevus)",
            "what": "بقعة/شامة صبغية غالباً حميدة، لكن تحتاج متابعة إذا تغيّرت.",
            "safe": [
                "راقبي أي تغيّر (الحجم/اللون/الحدود/نزف).",
                "واقي شمس."
            ],
            "otc": [
                "واقي شمس."
            ],
            "see_doc": [
                "إذا تغيرت بسرعة أو نزفت أو شكلها غير منتظم."
            ]
        },

        "melanoma": {
            "name": "ميلانوما (Melanoma) — يلزم طبيب",
            "what": "نوع خطير من سرطان الجلد. أي شك يحتاج تقييم طبي سريع.",
            "safe": [
                "لا تعالجيها بكريمات في البيت.",
                "صوريها وراقبي تغيّرها."
            ],
            "otc": [
                "لا يوجد OTC يعالج السبب."
            ],
            "see_doc": [
                "راجعي طبيب جلدية بأقرب وقت (مهم)."
            ]
        },

        "basal cell carcinoma": {
            "name": "سرطان الخلايا القاعدية (Basal cell carcinoma) — يلزم طبيب",
            "what": "سرطان جلدي شائع بطيء النمو غالباً، يحتاج تشخيص وعلاج طبي.",
            "safe": [
                "واقي شمس وتجنب العبث بالآفة."
            ],
            "otc": [
                "لا يوجد OTC يعالج السبب."
            ],
            "see_doc": [
                "راجعي طبيب جلدية للتأكد والعلاج."
            ]
        },

        "seborrheic keratoses": {
            "name": "تقرّن دهني (Seborrheic keratoses)",
            "what": "نمو جلدي حميد شائع يشبه “لصقة” على الجلد.",
            "safe": [
                "لا تحاولي إزالته بنفسك."
            ],
            "otc": [
                "لا يلزم OTC عادةً."
            ],
            "see_doc": [
                "إذا تغير شكله بسرعة أو نزف أو كان هناك شك بالتشخيص."
            ]
        },

        "cutaneous larva migrans": {
            "name": "اليرقة الجلدية المهاجرة (Cutaneous larva migrans)",
            "what": "مسارات/خطوط حاكة بالجلد غالباً بعد رمل/تربة ملوثة. يحتاج تقييم طبي.",
            "safe": [
                "تجنبي الحكّ الشديد لتفادي الالتهاب."
            ],
            "otc": [
                "لا يوجد OTC يعالج السبب عادةً."
            ],
            "see_doc": [
                "يفضل طبيب لأن علاجه غالباً بوصفة."
            ]
        }
    }

    # مطابقة مرنة: label قد يكون underscore أو space أو اختلاف حروف
    key = None
    for k in DB.keys():
        if k in label_clean:
            key = k
            break

    if key is None:
        return (
            "تنبيه: هذا شرح تثقيفي فقط وليس تشخيصاً طبياً.\n\n"
            f"التوقع الأول: {label or 'غير معروف'}\n"
            f"أفضل 3 توقعات:\n{top3_txt}\n\n"
            f"ملاحظاتك: {notes_txt}\n\n"
            "نصائح عامة آمنة قبل الطبيب:\n"
            "- نظافة لطيفة بدون فرك.\n"
            "- تجنبي العطور/الخلطات/الكورتيزون العشوائي.\n"
            "- إذا في ألم شديد/سخونة/صديد/انتشار سريع/حمّى → راجعي طبيب فوراً.\n"
        )

    info = DB[key]

    out = []
    out.append("تنبيه مهم: هذا ناتج ذكاء اصطناعي للتثقيف فقط وليس تشخيصاً طبياً.")
    out.append("")
    out.append(f"التوقع الأول: {info['name']}")
    out.append("أفضل 3 توقعات من النموذج:")
    out.append(top3_txt)
    out.append("")
    out.append(f"ملاحظاتك: {notes_txt}")
    out.append("")
    out.append("1) ما هي الحالة؟")
    out.append(info["what"])
    out.append("")
    out.append("2) نصائح عامة آمنة قبل زيارة الطبيب:")
    out.extend([f"- {x}" for x in info["safe"]])
    out.append("")
    out.append("3) أمثلة خيارات ممكن تُسأل بالصيدلية (OTC) *بدون وصفة*:")
    out.append("ملاحظة: لا تستخدمي أي شيء إذا عندك حساسية/حمل/طفل صغير بدون سؤال الصيدلي/الطبيب.")
    out.extend([f"- {x}" for x in info["otc"]])
    out.append("")
    out.append("4) متى لازم طبيب/طوارئ؟")
    out.extend([f"- {x}" for x in info["see_doc"]])

    return "\n".join(out)
